{% extends "base.html" %}

{% block title %}Contagem - SysStock{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üì∑ Contagem de Estoque com Scanner</h1>
    <p>Use a c√¢mera ou campo de busca para registrar os itens contados.</p>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top:20px;">
    <div class="stat-card">
        <h3>üé• Scanner de C√≥digo de Barras</h3>
        
        <div id="camera-wrapper" style="position: relative; width: 100%; height: 350px; overflow: hidden; background: #000; border-radius: 10px; margin-top: 15px;">
            <div id="interactive" class="viewport" style="width: 100%; height: 100%;"></div>
            <div id="camera-overlay" style="position: absolute; top: 50%; left: 10%; right: 10%; height: 3px; background: red; box-shadow: 0 0 10px red; display: none;"></div>
            <div style="position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px; border-radius: 5px; font-size: 0.8rem; text-align: center;">
                Status da C√¢mera: <span id="statusCamera" style="font-weight: bold; color: yellow;">Inativa</span>
            </div>
        </div>

        <h3 style="margin-top: 20px;">üì¶ Quantidade por Leitura</h3>
        <input
            type="number"
            id="inputQtd"
            value="1"
            min="1"
            step="1"
            style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc;"
        >
        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
            A quantidade ser√° aplicada a cada leitura do c√≥digo.
        </p>

        <button id="btnCamera" class="btn btn-secondary btn-block" style="margin-top: 15px;" onclick="toggleCamera()">
            ‚ñ∂Ô∏è Ligar C√¢mera / Iniciar Scanner
        </button>

        <h3 style="margin-top: 30px;">üîç Busca Manual / C√≥digo</h3>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="inputManual" placeholder="Digite o C√≥digo Interno ou EAN" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px;">
            <button class="btn btn-primary" onclick="adicionarItemManual()">Adicionar</button>
        </div>
        <p style="margin-top:10px; font-size:0.9rem;">Dica: Digite o c√≥digo e pressione **Enter**.</p>
    </div>
    
    <div class="stat-card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
            Itens Contados 
            <span style="font-size: 1rem; font-weight: normal; color: #555;">Total: <strong id="totalItens">0</strong></span>
        </h3>
        
        <div id="tabelaContagemWrapper" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
            <table id="tabelaContagem" class="table-striped">
                <thead>
                    <tr>
                        <th style="width: 80px;">C√≥digo</th>
                        <th>Descri√ß√£o</th>
                        <th style="width: 100px;">Quantidade</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {# Preenchido via JS #}
                </tbody>
            </table>
        </div>
        
        <button id="btnFinalizar" class="btn btn-success btn-block" style="margin-top: 20px; display:none; font-size: 1.1rem; padding: 12px;" onclick="finalizarContagem()">
            üíæ Finalizar e Salvar Contagem
        </button>
        
        <a href="{{ url_for('movimentacoes') }}" class="btn btn-secondary btn-block" style="margin-top: 10px; font-size: 1.1rem; padding: 12px;">
            Hist√≥rico de Movimenta√ß√µes
        </a>
    </div>
</div>

<style>
    .hidden { display: none !important; }
    #interactive video, #interactive canvas { 
        width: 100% !important; 
        height: 100% !important; 
        object-fit: cover; 
    }
    #interactive canvas.drawingBuffer { position: absolute; top: 0; left: 0; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    #camera-overlay { animation: pulse 1.5s infinite; }
</style>
{% endblock %}

{% block extra_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="{{ url_for('static', filename='js/barcode_scanner.js') }}"></script>

    <script>
    window.fetchItensContagem = async function() {
        try {
            const response = await fetch('/api/contagem/list');
            const data = await response.json();
            
            if (data.success) {
                window.contagemItens = data.itens;
                
                if (typeof window.atualizarTabelaContagem === 'function') {
                    window.atualizarTabelaContagem(data.itens);
                }
                
                document.getElementById('totalItens').textContent = data.itens.length;
                document.getElementById('btnFinalizar').style.display = data.itens.length > 0 ? 'block' : 'none';
            }
        } catch (err) {
            console.error("Erro ao carregar lista de contagem:", err);
        }
    };


    window.addEventListener('load', function() {
        window.fetchItensContagem();
        
        const inputManual = document.getElementById('inputManual');
        if (inputManual) {
            inputManual.addEventListener("keypress", function(e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    adicionarItemManual();
                }
            });
        }
    });


    function adicionarItemManual() {
        const input = document.getElementById('inputManual');
        const codigo = input.value.trim();
        const qtdInput = document.getElementById('inputQtd');
        const quantidade = qtdInput ? parseFloat(qtdInput.value) || 1 : 1;

        if (!codigo) {
            alert('Digite um c√≥digo ou EAN.');
            return;
        }
        
        if (typeof processarCodigo === 'function') {
            processarCodigo(codigo, quantidade);
        }
        
        input.value = ''; 
        input.focus();
    }

    function finalizarContagem() {
        if (!confirm("Deseja finalizar a contagem e atualizar o estoque real?")) return;

        fetch('/api/contagem/finalizar', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("‚úÖ Estoque atualizado com sucesso!");
                    window.location.reload();
                } else {
                    alert("‚ùå Erro: " + data.message);
                }
            });
    }
    </script>
{% endblock %}