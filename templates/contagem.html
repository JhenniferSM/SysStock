{% extends "base.html" %}

{% block title %}Contagem - SysStock{% endblock %}

{% block content %}
<div class="page-header">
    <h1>游닝 Contagem de Estoque com Scanner</h1>
    <p>Use a c칙mera ou campo de busca para registrar os itens contados.</p>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top:20px;">
    <div class="stat-card">
        <h3>游꿘 Scanner de C칩digo de Barras</h3>
        
        <div id="camera-wrapper" style="position: relative; width: 100%; height: 350px; overflow: hidden; background: #000; border-radius: 10px; margin-top: 15px;">
            <div id="interactive" class="viewport" style="width: 100%; height: 100%;"></div>
            <div id="camera-overlay" style="position: absolute; top: 50%; left: 10%; right: 10%; height: 3px; background: red; box-shadow: 0 0 10px red; display: none;"></div>
            <div style="position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px; border-radius: 5px; font-size: 0.8rem; text-align: center;">
                Status da C칙mera: <span id="statusCamera" style="font-weight: bold; color: yellow;">Inativa</span>
            </div>
        </div>

        <h3 style="margin-top: 20px;">游닍 Quantidade por Leitura</h3>
        <input
            type="number"
            id="inputQtd"
            value="1"
            min="1"
            step="1"
            style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc;"
        >
        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
            A quantidade ser치 aplicada a cada leitura do c칩digo.
        </p>

        <button id="btnCamera" class="btn btn-secondary btn-block" style="margin-top: 15px;" onclick="toggleCamera()">
            郊윒잺 Ligar C칙mera / Iniciar Scanner
        </button>

        <h3 style="margin-top: 30px;">游댌 Busca Manual / C칩digo</h3>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="inputManual" placeholder="Digite o C칩digo Interno ou EAN" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px;">
            <button class="btn btn-primary" onclick="adicionarItemManual()">Adicionar</button>
        </div>
        <p style="margin-top:10px; font-size:0.9rem;">Dica: Digite o c칩digo e pressione **Enter**.</p>
    </div>
    
    <div class="stat-card">
        <h3 style="display: flex; justify-content: space-between; align-items: center;">
            Itens Contados 
            <span style="font-size: 1rem; font-weight: normal; color: #555;">Total: <strong id="totalItens">0</strong></span>
        </h3>
        
        <div id="tabelaContagemWrapper" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
            <table id="tabelaContagem" class="table-striped">
                <thead>
                    <tr>
                        <th style="width: 80px;">C칩digo</th>
                        <th>Descri칞칚o</th>
                        <th style="width: 100px;">Quantidade</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {# Linhas ser칚o preenchidas via JavaScript #}
                </tbody>
            </table>
        </div>
        
        <button id="btnFinalizar" class="btn btn-success btn-block" style="margin-top: 20px; display:none; font-size: 1.1rem; padding: 12px;" onclick="finalizarContagem()">
            游 Finalizar e Salvar Contagem
        </button>
        
        <a href="{{ url_for('movimentacoes') }}" class="btn btn-secondary btn-block" style="margin-top: 10px; font-size: 1.1rem; padding: 12px;">
            Hist칩rico de Movimenta칞칫es
        </a>
    </div>
</div>

<style>
    .hidden { display: none !important; }
    
    /* V칤deo do Quagga */
    #interactive video, #interactive canvas { 
        width: 100% !important; 
        height: 100% !important; 
        object-fit: cover; 
    }
    
    /* Canvas de desenho sobreposto */
    #interactive canvas.drawingBuffer {
        position: absolute;
        top: 0;
        left: 0;
    }
    
    /* Anima칞칚o de pulso na linha de scan */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    #camera-overlay {
        animation: pulse 1.5s infinite;
    }
</style>

{% endblock %}

{% block extra_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="{{ url_for('static', filename='js/barcode_scanner.js') }}"></script>

    <script>
    // Atualiza contador de itens
    function atualizarContador() {
        document.getElementById('totalItens').textContent = contagemItens.length;
    }

    // Sobrescrever a fun칞칚o original para incluir contador e carregar ao iniciar
    window.addEventListener('load', function() {
        // Sobrescreve a fun칞칚o atualizarTabelaContagem do barcode_scanner.js
        const originalAtualizarTabela = window.atualizarTabelaContagem;
        window.atualizarTabelaContagem = function(itens) {
            originalAtualizarTabela(itens);
            atualizarContador(); // Chama a fun칞칚o local
            const btnFinalizar = document.getElementById('btnFinalizar');
            if (itens && itens.length > 0) {
                btnFinalizar.style.display = 'block';
            } else {
                btnFinalizar.style.display = 'none';
            }
        };
        
        // Dispara a carga inicial dos itens de contagem
        window.atualizarTabelaContagem(window.contagemItens || []); 
        fetchItensContagem();
        
        // Evento de Enter no campo manual
        const inputManual = document.getElementById('inputManual');
        if (inputManual) {
            inputManual.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    adicionarItemManual();
                }
            });
        }
    });

    // Busca os itens existentes no banco de dados ao carregar a p치gina
    function fetchItensContagem() {
        fetch('/api/contagem/list')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.contagemItens = data.itens;
                    window.atualizarTabelaContagem(data.itens);
                } else {
                    console.error("Erro ao carregar contagem:", data.message);
                }
            })
            .catch(err => console.error("Erro de comunica칞칚o ao carregar contagem:", err));
    }

    // Fun칞칚o para adicionar item manualmente (c칩digo ou EAN)
    function adicionarItemManual() {
        const input = document.getElementById('inputManual');
        const codigo = input.value.trim();
        if (!codigo) {
            alert('Digite um c칩digo ou EAN.');
            return;
        }
        
        // Chama a fun칞칚o central do scanner
        processarCodigo(codigo, 1.0);
        input.value = ''; // Limpa o campo
        input.focus();
    }

    // Sobrescreve a fun칞칚o de processamento de c칩digo do scanner
    const originalProcessarCodigo = window.processarCodigo;
    window.processarCodigo = function(code, quantidade) {
        if (originalProcessarCodigo) {
            originalProcessarCodigo(code, quantidade);
        } else {
            // Se a fun칞칚o n칚o foi carregada (erro), tenta o processamento manual
            adicionarItemApi(code, quantidade);
        }
    }

</script>
{% endblock %}